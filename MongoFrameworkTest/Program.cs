using AutoMapper;
using MongoDB.Driver;
using MongoFramework;
using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace MongoFrameworkTest
{
    class Program
    {
        private static async Task Main(string[] args)
        {
            var connection = MongoDbConnection.FromUrl(new MongoUrl("mongodb://KCTroy:V245ZGxbEhn3Sakk@localhost:27017/Troy-Dev"));
            string jsonString = "[{\"DeviceId\":\"2957bba1a24d4460907bdc310c36936f,d385142191aa2372c7c35068b5cd5913\",\"DeviceMac\":\"B0F89365EDB4\",\"DeviceType\":\"lock\",\"DeviceSn\":\"d385142191aa2372c7c35068b5cd5913\",\"DeviceName\":\"L9\",\"Description\":null,\"HomeId\":null,\"RoomId\":\"2957bba1a24d4460907bdc310c36936f\",\"AssetTenancyId\":null,\"IsAssociated\":false,\"ApartmentId\":null,\"AssociatedRoomId\":null,\"IsPublic\":false,\"Token\":null,\"AssociateTime\":null,\"AssociatorName\":null,\"CenterUUID\":null,\"BindTime\":null,\"OnOffLine\":false,\"OnOffTime\":null,\"DevicePower\":50,\"PowerRefreshTime\":null,\"Model\":\"L9-WIFI-QINGKE\",\"ModelName\":\"L9\",\"Lqi\":0,\"LqiRefreshTime\":null,\"Versions\":\"{\\\"app_version\\\":\\\"Ver:B1.2.4.58\\\\u0000\\\\u0000\\\"}\",\"Supplier\":\"Coolkit\",\"OpenId\":\"Ml7PxKSetxJ85Kwn1UNIPOrXkSPWrJ1O\",\"DeviceCustomName\":null,\"OtherDataPayload\":\"{\\\"brand\\\":\\\"Coolkit\\\",\\\"centerDescription\\\":null,\\\"centerSn\\\":null}\",\"Enabled\":true,\"ActorId\":\"2957bba1a24d4460907bdc310c36936f,d385142191aa2372c7c35068b5cd5913\",\"CreateTime\":\"2019-05-21T01:41:24.1299318+08:00\",\"UpdateTime\":\"2019-05-21T01:41:24.1299321+08:00\",\"DataPayload\":\"{}\"},{\"DeviceId\":\"631776214c794c9abd264eeb3da6af8c,351eff575d1be024d2e94bee1ae7c13d\",\"DeviceMac\":\"B0F89365EEA2\",\"DeviceType\":\"lock\",\"DeviceSn\":\"351eff575d1be024d2e94bee1ae7c13d\",\"DeviceName\":\"L9\",\"Description\":null,\"HomeId\":null,\"RoomId\":\"631776214c794c9abd264eeb3da6af8c\",\"AssetTenancyId\":null,\"IsAssociated\":false,\"ApartmentId\":null,\"AssociatedRoomId\":null,\"IsPublic\":false,\"Token\":null,\"AssociateTime\":null,\"AssociatorName\":null,\"CenterUUID\":null,\"BindTime\":null,\"OnOffLine\":false,\"OnOffTime\":null,\"DevicePower\":100,\"PowerRefreshTime\":null,\"Model\":\"L9-WIFI-QINGKE\",\"ModelName\":\"L9\",\"Lqi\":0,\"LqiRefreshTime\":null,\"Versions\":\"{\\\"app_version\\\":\\\"Ver:B1.2.4.60\\\\u0000\\\\u0000\\\"}\",\"Supplier\":\"Coolkit\",\"OpenId\":\"Ml7PxKSetxJ85Kwn1UNIPOrXkSPWrJ1O\",\"DeviceCustomName\":null,\"OtherDataPayload\":\"{\\\"brand\\\":\\\"Coolkit\\\",\\\"centerDescription\\\":null,\\\"centerSn\\\":null}\",\"Enabled\":true,\"ActorId\":\"631776214c794c9abd264eeb3da6af8c,351eff575d1be024d2e94bee1ae7c13d\",\"CreateTime\":\"2019-05-18T01:41:58.1460649+08:00\",\"UpdateTime\":\"2019-05-20T01:48:00.5837868+08:00\",\"DataPayload\":\"{}\"},{\"DeviceId\":\"d31ff7af388b4305a92e95344e36785a,351eff575d1be024d2e94bee1ae7c13d\",\"DeviceMac\":\"B0F89365EEA2\",\"DeviceType\":\"lock\",\"DeviceSn\":\"351eff575d1be024d2e94bee1ae7c13d\",\"DeviceName\":\"华空间\",\"Description\":null,\"HomeId\":null,\"RoomId\":\"d31ff7af388b4305a92e95344e36785a\",\"AssetTenancyId\":\"3E0D49CE950A424FBF6D5F6A57231CF0\",\"IsAssociated\":false,\"ApartmentId\":\"1A62CBDB69CB44DDA895016A4FB9EABA\",\"AssociatedRoomId\":\"30CE1E74E37344529326016A4FB9FA9F\",\"IsPublic\":false,\"Token\":null,\"AssociateTime\":\"2019-05-14T15:36:16.6046598+08:00\",\"AssociatorName\":\"蜂鸟公寓\",\"CenterUUID\":null,\"BindTime\":\"2019-05-14T15:21:40.5062714+08:00\",\"OnOffLine\":true,\"OnOffTime\":null,\"DevicePower\":75,\"PowerRefreshTime\":null,\"Model\":\"L9-WIFI-QINGKE\",\"ModelName\":\"L9\",\"Lqi\":0,\"LqiRefreshTime\":null,\"Versions\":\"{\\\"app_version\\\":\\\"Ver:B1.2.4.60\\\\u0000\\\\u0000\\\"}\",\"Supplier\":\"Coolkit\",\"OpenId\":\"Ml7PxKSetxJ85Kwn1UNIPOrXkSPWrJ1O\",\"DeviceCustomName\":\"华空间\",\"OtherDataPayload\":\"{\\\"brand\\\":\\\"Coolkit\\\",\\\"centerDescription\\\":null,\\\"centerSn\\\":null}\",\"Enabled\":true,\"ActorId\":\"d31ff7af388b4305a92e95344e36785a,351eff575d1be024d2e94bee1ae7c13d\",\"CreateTime\":\"2019-05-13T17:18:34.9210917+08:00\",\"UpdateTime\":\"2019-05-18T01:41:58.238471+08:00\",\"DataPayload\":\"{}\"},{\"DeviceId\":\"58129667\",\"DeviceMac\":\"\",\"DeviceType\":\"coldwatermeter\",\"DeviceSn\":\"58129667\",\"DeviceName\":\"1115-水表\",\"Description\":null,\"HomeId\":\"-1018227899\",\"RoomId\":\"1785890062\",\"AssetTenancyId\":null,\"IsAssociated\":false,\"ApartmentId\":null,\"AssociatedRoomId\":null,\"IsPublic\":false,\"Token\":null,\"AssociateTime\":null,\"AssociatorName\":null,\"CenterUUID\":\"三林有巢公馆11\",\"BindTime\":\"2019-05-13T16:25:19+08:00\",\"OnOffLine\":true,\"OnOffTime\":\"2019-05-13T17:14:11.1708225+08:00\",\"DevicePower\":100,\"PowerRefreshTime\":\"2019-05-13T17:14:11.1708265+08:00\",\"Model\":\"JOY\",\"ModelName\":\"JOY\",\"Lqi\":1,\"LqiRefreshTime\":null,\"Versions\":null,\"Supplier\":\"Joymeter\",\"OpenId\":\"joy000001,http://122.225.71.66:211/ts\",\"DeviceCustomName\":null,\"OtherDataPayload\":\"{\\\"consumeAmount\\\":\\\"0\\\",\\\"consumeAmountTime\\\":\\\"2019-05-13 17:14:11\\\"}\",\"Enabled\":true,\"ActorId\":\"58129667\",\"CreateTime\":\"2019-05-13T17:14:11.1799554+08:00\",\"UpdateTime\":\"2019-05-13T17:14:11.1799557+08:00\",\"DataPayload\":\"{}\"},{\"DeviceId\":\"58129480\",\"DeviceMac\":\"\",\"DeviceType\":\"coldwatermeter\",\"DeviceSn\":\"58129480\",\"DeviceName\":\"1113-水表\",\"Description\":null,\"HomeId\":\"-1018227899\",\"RoomId\":\"-523827982\",\"AssetTenancyId\":null,\"IsAssociated\":false,\"ApartmentId\":null,\"AssociatedRoomId\":null,\"IsPublic\":false,\"Token\":null,\"AssociateTime\":null,\"AssociatorName\":null,\"CenterUUID\":\"三林有巢公馆11\",\"BindTime\":\"2019-05-13T16:25:19+08:00\",\"OnOffLine\":true,\"OnOffTime\":\"2019-05-13T17:13:46.4066925+08:00\",\"DevicePower\":100,\"PowerRefreshTime\":\"2019-05-13T17:13:46.4066979+08:00\",\"Model\":\"JOY\",\"ModelName\":\"JOY\",\"Lqi\":1,\"LqiRefreshTime\":null,\"Versions\":null,\"Supplier\":\"Joymeter\",\"OpenId\":\"joy000001,http://122.225.71.66:211/ts\",\"DeviceCustomName\":null,\"OtherDataPayload\":\"{\\\"consumeAmount\\\":\\\"0\\\",\\\"consumeAmountTime\\\":\\\"2019-05-13 17:13:46\\\"}\",\"Enabled\":true,\"ActorId\":\"58129480\",\"CreateTime\":\"2019-05-13T17:13:46.4154639+08:00\",\"UpdateTime\":\"2019-05-13T17:13:46.4154642+08:00\",\"DataPayload\":\"{}\"},{\"DeviceId\":\"58129552\",\"DeviceMac\":\"\",\"DeviceType\":\"coldwatermeter\",\"DeviceSn\":\"58129552\",\"DeviceName\":\"1111-水表\",\"Description\":null,\"HomeId\":\"-1018227899\",\"RoomId\":\"866478493\",\"AssetTenancyId\":null,\"IsAssociated\":false,\"ApartmentId\":null,\"AssociatedRoomId\":null,\"IsPublic\":false,\"Token\":null,\"AssociateTime\":null,\"AssociatorName\":null,\"CenterUUID\":\"三林有巢公馆11\",\"BindTime\":\"2019-05-13T16:25:19+08:00\",\"OnOffLine\":true,\"OnOffTime\":\"2019-05-13T17:13:21.6967695+08:00\",\"DevicePower\":100,\"PowerRefreshTime\":\"2019-05-13T17:13:21.696775+08:00\",\"Model\":\"JOY\",\"ModelName\":\"JOY\",\"Lqi\":1,\"LqiRefreshTime\":null,\"Versions\":null,\"Supplier\":\"Joymeter\",\"OpenId\":\"joy000001,http://122.225.71.66:211/ts\",\"DeviceCustomName\":null,\"OtherDataPayload\":\"{\\\"consumeAmount\\\":\\\"0\\\",\\\"consumeAmountTime\\\":\\\"2019-05-13 17:13:21\\\"}\",\"Enabled\":true,\"ActorId\":\"58129552\",\"CreateTime\":\"2019-05-13T17:13:21.7076921+08:00\",\"UpdateTime\":\"2019-05-13T17:13:21.7076923+08:00\",\"DataPayload\":\"{}\"},{\"DeviceId\":\"58129638\",\"DeviceMac\":\"\",\"DeviceType\":\"coldwatermeter\",\"DeviceSn\":\"58129638\",\"DeviceName\":\"1109-水表\",\"Description\":null,\"HomeId\":\"-1018227899\",\"RoomId\":\"-437756848\",\"AssetTenancyId\":null,\"IsAssociated\":false,\"ApartmentId\":null,\"AssociatedRoomId\":null,\"IsPublic\":false,\"Token\":null,\"AssociateTime\":null,\"AssociatorName\":null,\"CenterUUID\":\"三林有巢公馆11\",\"BindTime\":\"2019-05-13T16:25:19+08:00\",\"OnOffLine\":true,\"OnOffTime\":\"2019-05-13T17:12:56.9589024+08:00\",\"DevicePower\":100,\"PowerRefreshTime\":\"2019-05-13T17:12:56.958906+08:00\",\"Model\":\"JOY\",\"ModelName\":\"JOY\",\"Lqi\":1,\"LqiRefreshTime\":null,\"Versions\":null,\"Supplier\":\"Joymeter\",\"OpenId\":\"joy000001,http://122.225.71.66:211/ts\",\"DeviceCustomName\":null,\"OtherDataPayload\":\"{\\\"consumeAmount\\\":\\\"0\\\",\\\"consumeAmountTime\\\":\\\"2019-05-13 17:12:56\\\"}\",\"Enabled\":true,\"ActorId\":\"58129638\",\"CreateTime\":\"2019-05-13T17:12:56.9681571+08:00\",\"UpdateTime\":\"2019-05-13T17:12:56.9681573+08:00\",\"DataPayload\":\"{}\"},{\"DeviceId\":\"58129661\",\"DeviceMac\":\"\",\"DeviceType\":\"coldwatermeter\",\"DeviceSn\":\"58129661\",\"DeviceName\":\"1105-水表\",\"Description\":null,\"HomeId\":\"-1018227899\",\"RoomId\":\"2106246840\",\"AssetTenancyId\":null,\"IsAssociated\":false,\"ApartmentId\":null,\"AssociatedRoomId\":null,\"IsPublic\":false,\"Token\":null,\"AssociateTime\":null,\"AssociatorName\":null,\"CenterUUID\":\"三林有巢公馆11\",\"BindTime\":\"2019-05-13T16:25:19+08:00\",\"OnOffLine\":true,\"OnOffTime\":\"2019-05-13T17:12:31.8650926+08:00\",\"DevicePower\":100,\"PowerRefreshTime\":\"2019-05-13T17:12:31.8650965+08:00\",\"Model\":\"JOY\",\"ModelName\":\"JOY\",\"Lqi\":1,\"LqiRefreshTime\":null,\"Versions\":null,\"Supplier\":\"Joymeter\",\"OpenId\":\"joy000001,http://122.225.71.66:211/ts\",\"DeviceCustomName\":null,\"OtherDataPayload\":\"{\\\"consumeAmount\\\":\\\"0\\\",\\\"consumeAmountTime\\\":\\\"2019-05-13 17:12:31\\\"}\",\"Enabled\":true,\"ActorId\":\"58129661\",\"CreateTime\":\"2019-05-13T17:12:31.8743347+08:00\",\"UpdateTime\":\"2019-05-13T17:12:31.874335+08:00\",\"DataPayload\":\"{}\"},{\"DeviceId\":\"58129647\",\"DeviceMac\":\"\",\"DeviceType\":\"coldwatermeter\",\"DeviceSn\":\"58129647\",\"DeviceName\":\"1106-水表\",\"Description\":null,\"HomeId\":\"-1018227899\",\"RoomId\":\"-2054142394\",\"AssetTenancyId\":null,\"IsAssociated\":false,\"ApartmentId\":null,\"AssociatedRoomId\":null,\"IsPublic\":false,\"Token\":null,\"AssociateTime\":null,\"AssociatorName\":null,\"CenterUUID\":\"三林有巢公馆11\",\"BindTime\":\"2019-05-13T16:25:20+08:00\",\"OnOffLine\":true,\"OnOffTime\":\"2019-05-13T17:12:07.1303753+08:00\",\"DevicePower\":100,\"PowerRefreshTime\":\"2019-05-13T17:12:07.1303794+08:00\",\"Model\":\"JOY\",\"ModelName\":\"JOY\",\"Lqi\":1,\"LqiRefreshTime\":null,\"Versions\":null,\"Supplier\":\"Joymeter\",\"OpenId\":\"joy000001,http://122.225.71.66:211/ts\",\"DeviceCustomName\":null,\"OtherDataPayload\":\"{\\\"consumeAmount\\\":\\\"0\\\",\\\"consumeAmountTime\\\":\\\"2019-05-13 17:12:07\\\"}\",\"Enabled\":true,\"ActorId\":\"58129647\",\"CreateTime\":\"2019-05-13T17:12:07.1397528+08:00\",\"UpdateTime\":\"2019-05-13T17:12:07.1397534+08:00\",\"DataPayload\":\"{}\"},{\"DeviceId\":\"58129674\",\"DeviceMac\":\"\",\"DeviceType\":\"coldwatermeter\",\"DeviceSn\":\"58129674\",\"DeviceName\":\"1131-水表\",\"Description\":null,\"HomeId\":\"-1018227899\",\"RoomId\":\"-245878762\",\"AssetTenancyId\":null,\"IsAssociated\":false,\"ApartmentId\":null,\"AssociatedRoomId\":null,\"IsPublic\":false,\"Token\":null,\"AssociateTime\":null,\"AssociatorName\":null,\"CenterUUID\":\"三林有巢公馆11\",\"BindTime\":\"2019-05-13T16:25:20+08:00\",\"OnOffLine\":true,\"OnOffTime\":\"2019-05-13T17:11:41.9921979+08:00\",\"DevicePower\":100,\"PowerRefreshTime\":\"2019-05-13T17:11:41.9922062+08:00\",\"Model\":\"JOY\",\"ModelName\":\"JOY\",\"Lqi\":1,\"LqiRefreshTime\":null,\"Versions\":null,\"Supplier\":\"Joymeter\",\"OpenId\":\"joy000001,http://122.225.71.66:211/ts\",\"DeviceCustomName\":null,\"OtherDataPayload\":\"{\\\"consumeAmount\\\":\\\"0\\\",\\\"consumeAmountTime\\\":\\\"2019-05-13 17:11:41\\\"}\",\"Enabled\":true,\"ActorId\":\"58129674\",\"CreateTime\":\"2019-05-13T17:11:42.0330029+08:00\",\"UpdateTime\":\"2019-05-13T17:11:42.0330032+08:00\",\"DataPayload\":\"{}\"}]";
            List<DeviceView> list = JsonConvert.DeserializeObject<List<DeviceView>>(jsonString);
            //using (var myContext = new DeviceMongoContext(connection))
            //{
            //    myContext.DeviceModels.AddRange(list);
            //    await myContext.SaveChangesAsync();
            //}
            //using (var myContext = new DeviceMongoContext(connection))
            //{
            //    list=myContext.DeviceModels.Take(5).ToList();
            //    myContext.DeviceModels.RemoveRange(list);
            //    await myContext.SaveChangesAsync();
            //}
          
            DeviceView deviceView = list.Where(x => x.DeviceId == "2957bba1a24d4460907bdc310c36936f,d385142191aa2372c7c35068b5cd5913").FirstOrDefault();
            deviceView.Description = "mongoTest";
            
            using (var myContext = new DeviceMongoContext(connection))
            {
                //var config = new MapperConfiguration(cfg => cfg.CreateMap<DeviceView, DeviceView>());
                Mapper.Initialize(cfg => cfg.CreateMap<DeviceView, DeviceView>());
                DeviceView device = myContext.DeviceModels.Where(x => x.DeviceId == "2957bba1a24d4460907bdc310c36936f,d385142191aa2372c7c35068b5cd5913").FirstOrDefault();
                device = Mapper.Map<DeviceView>(deviceView);
                //myContext.DeviceModels.Update(device);
                 await myContext.SaveChangesAsync();
                device = myContext.DeviceModels.Where(x => x.DeviceId == "2957bba1a24d4460907bdc310c36936f,d385142191aa2372c7c35068b5cd5913").FirstOrDefault();
            }
            
            Console.WriteLine("Hello World!");
        }
    }
}
